#include<iostream>
#include<conio.h>
#include<stdio.h> 
#include<windows.h>
#include<stdlib.h>
#include<windows.h>
#include<fstream>
#include<string.h>
#include<time.h>
void start();
int flag;
char ch;
struct date
{
    short int day;
    short int month;
    int year;
};

struct Time
{
    short int hour;
    short int minute;
};

class Account
{
    private :
        char password[20];
        char email[40];
    public :
        char* get_email()
        {
            return email;
        }
        char* get_pass()
        {
            return password;
        }
        void create_account()
        {
            int opt = 0;
            do
            {
                start();
                Account obj;
                char check[20];
                cout<<"\n Enter Your Email Id : ";
                gets(obj.email);
                cout<<"\n Enter A Password : ";
                gets(obj.password);
                start();
                cout<<"\n Retype the password to confirm change ";
                gets(check);
                if(strcmp(check, obj.get_pass())==0)
                {
                    ofstream file("Acc.dat", ios::binary | ios::app);
                    file.write((char*)&obj, sizeof(obj));
                    file.close();
                    opt = 1;
                    return;
                }
                else
                {
                    cout<<"\n Incorrect Match. "<<endl<<"Please Try Again";
                    opt = 0;
                }
            }while( opt == 1 );
        }
};

class Train
{
        private :
            long int tno;
            char tname[20], depcity[20], arrcity[20];
            date depdate, arrdate;
            Time deptime, arrtime, tottime;
            float dist, price;
        public :
            long get_tno()
            {
                return tno;
            }
            char* get_arrcity()
            {
                return arrcity;
            }
            char* get_depcity()
            {
                return depcity;
            }
            Train()
            {
                tno = 0;
                strcpy(tname, "Null");
                strcpy(depcity, "Null");
                strcpy(arrcity, "Null");
                depdate = {0,0,0};
                arrdate = {0,0,0};
                deptime = {0,0};
                arrtime = {0,0};
                tottime = {0,0};
                dist = 0;
                price = 0;
            }
            void get_details()
            {
                cout<<"\n Enter Train number : ";
                cin>>tno;
                cout<<" Enter Train name : ";
                gets(tname);
                cout<<" Enter Departure City : ";
                gets(depcity);
                cout<<" Enter Arrival City : ";
                gets(arrcity);
                cout<<" Enter Total Distance : ";
                cin>>dist;
                cout<<" Enter Departure Date - \n";
                cout<<"     Enter Day : ";
                cin>>depdate.day;
                cout<<"     Enter Month : ";
                cin>>depdate.month;
                cout<<"     Enter Year : ";
                cin>>depdate.year;
                cout<<" Enter Arrival Date - \n";
                cout<<"     Enter Day : ";
                cin>>arrdate.day;
                cout<<"     Enter Month : ";
                cin>>arrdate.month;
                cout<<"     Enter Year : ";
                cin>>arrdate.year;
                cout<<" Enter Departure Time - \n";
                cout<<"     Enter Hour : ";
                cin>>deptime.hour;
                cout<<"     Enter Minute : ";
                cin>>deptime.minute;
                cout<<" Enter Arrival Time - \n";
                cout<<"     Enter Hour : ";
                cin>>arrtime.hour;
                cout<<"     Enter Minute : ";
                cin>>arrtime.minute;
                cout<<" Enter Total time of journey  - \n";
                cout<<"     Enter Hour : ";
                cin>>tottime.hour;
                cout<<"     Enter Minute : ";
                cin>>tottime.minute;
                cout<<" Enter price of each ticket : ";
                cin>>price;
            }
            void print_details()
            {
                cout<<"\n\n Train number : ";
                cout<<tno;
                cout<<"\n Train name : ";
                puts(tname);
                cout<<" Departure City : ";
                puts(depcity);
                cout<<" Arrival City : ";
                puts(arrcity);
                cout<<" Total Distance ( in km ) : "<<dist;
                cout<<"\n Departure Date - "<<depdate.day<<"-"<<depdate.month<<"-"<<depdate.year;
                cout<<"\n Arrival Date - "<<arrdate.day<<"-"<<arrdate.month<<"-"<<arrdate.year;
                cout<<"\n Departure Time - "<<deptime.hour<<":"<<deptime.minute;
                cout<<"\n Arrival Time - "<<arrtime.hour<<":"<<arrtime.minute;
                cout<<"\n Total time of journey  - "<<tottime.hour<<" hours & "<<tottime.minute<<" minutes";
                cout<<"\n Price of ticket : "<<price;
            }
            ~Train()
            {

            }
};
class Passenger : public Train, public Account
{
    private :
        char pname[20], mail[40];
        int age;
        long int tickno;
        long int mobno, trno;
    public :
         Passenger()
         {
                strcpy(mail, "Null");
                strcpy(pname, "Null");
                age=0;
                tickno = ( rand()%899 + 1000 );
                mobno = 0;
         }
         void set_mail( char str[] )
         {
             strcpy(mail, str);
         }
         void getdata()
         {
            cout<<"\n Enter Passenger Name : ";
            gets(pname);
            cout<<" Enter Train Number : ";
            cin>>trno;
            cout<<" Age : ";
            cin>>age;
            cout<<" Enter Mobile Number : ";
            cin>>mobno;
            ifstream f1("Train.dat", ios::binary);
            flag = 0;
            Train obj;
            while(!f1.eof())
            {
                f1.read((char*)&obj, sizeof(obj));
                if(obj.get_tno() == trno)
                {
                    flag = 1;
                    break;
                }
            }
            if(flag==0)
                cout<<" Train Not Available ";
         }
         void putdata()
         {
            cout<<"\n Ticket no : "<<tickno;
            cout<<"\n Passenger Name : ";
            puts(pname);
            cout<<"\n Email : ";
            puts(mail);
            cout<<"\n Age : "<<age;
            cout<<"\n Mobile number : "<<mobno;
            cout<<"\n Train Number : "<<trno;
            cout<<"\n\n Do you want to view all details (Y/N) : ";
            cin>>ch;
            if(ch=='y'||ch=='Y')
            {
                Train obj;
                ifstream file("Train.dat", ios::binary);
                flag = 0;
                while( !file.eof() )
                {
                    file.read((char*)&obj, sizeof(obj));
                    if(trno ==obj.get_tno())
                    {
                        obj.print_details();
                        break;
                    }
                }
            }
         }
         void book_ticket( char str[40] )
         {
             Passenger obj;
             obj.getdata();
             start();
             obj.set_mail(str);
             char ch;
             cout<<" Your Ticket info is : /n /n";
             obj.putdata();
             cout<<"\n\n Do you want to confirm this ticket booking (Y/N) : ";
             cin>>ch;
             if((ch=='y')||(ch=='Y'))
             {
                 ofstream f2("Pass.dat", ios::binary | ios::app);
                 f2.write((char*)&obj, sizeof(obj));
                 f2.close();
                 cout<<"\n Your Ticket Has Been Booked ";
             }
             else
                 cout<<"\n Ticket Booking Cancelled ";
         }
         void display_tickets()
         {
             ifstream file("Pass.dat", ios::binary);
             Passenger obj;
             flag = 0;
             long int check = 0;
             while( !file.eof() )
             {
                  file.read((char*)&obj, sizeof(obj));
                  if(obj.age==0)
                     break;
                  if( check == obj.tickno )
                     break;
                  check = obj.tickno;
                  flag ++;
                  obj.putdata();
             }
             if(flag == 0)
                cout<<"\n No Booking Found ";
         }
         void search_ticket()
         {
            int flag = 0;
            long int ticket_no;
            Passenger pss;
            cout<<"\n Enter Ticket Number : ";
            cin>>ticket_no;
            ifstream file("Pass.dat", ios::binary);
            while( ! file.eof() )
            {
                file.read((char *) &pss, sizeof(pss));
                if( ticket_no==pss.tickno )
                {
                    pss.putdata();
                    flag = 1;
                    break;
                }
            }
            if(flag == 0)
                cout<<"\n No such passenger found";
            file.close();
        }
        void train_by_no()
         {
            long int train_no ;
            Train obj;
            int flag = 0;
            cout<<" Enter Train Number To Be Searched For : ";
            cin>>train_no;
            ifstream file( "Train.dat", ios::in );
            while( !file.eof() )
            {
                file.read((char*)&obj,sizeof(obj));
                if( train_no == obj.get_tno() )
                    flag = 1;
                    break;
            }
            if( flag==1 )
            {
                cout<<"\n Search Successful ";
                obj.print_details();
            }
            else
                cout<<"\n No Such Train Found ";
            file.close();
         }
         void train_by_city()
         {
            char dep[15],arr[15];
            cout<<" Enter Departure City : ";
            gets(dep);
            cout<<" Enter Arrival City: ";
            gets(arr);
            Train obj;
            int flag = 0;
            ifstream file( "Train.dat", ios::binary);
            long int check = 0;
            while( !file.eof() )
            {
                file.read((char*)&obj,sizeof(obj));
                if((strcmp(arr, obj.get_arrcity())==0)&&(strcmp(dep, obj.get_depcity())==0))
                {
                    if(flag == 0)
                        cout<<"\n Search Successful ";
                    flag = 1;
                    if(obj.get_tno()==check)
                        break;
                    check = obj.get_tno();
                    obj.print_details();
                }
            }
            if( flag==0)
                cout<<"\n No Such Train Found ";
            file.close();
         }
        void display_train()
        {
            Train obj;
            ifstream file( "Train.dat",ios::binary );
            flag = 0;
            while( !file.eof() )
            {
                file.read( (char*)&obj, sizeof(obj) );
                if((obj.get_tno()==0)&&(strcmp(obj.get_arrcity(),"Null")==0)&&(strcmp(obj.get_depcity(),"Null")==0))
                    break;
                if(obj.get_tno()== flag)
                    break;
                flag = obj.get_tno();
                obj.print_details();
            }
            if(flag==0)
                cout<<"\n There are no trains available currently .";
            file.close();
        }

        void add_train()  
        {
            Train obj;
            cout<<"\n Enter The following info to add train schedule ";
            obj.get_details();
            cout<<"/n/n Do you Want To Confirm This Train Schedule (Y/N) : ";
            cin>>ch;
            if(ch=='y'||ch=='Y')
            {
                ofstream file( "Train.dat", ios::binary | ios::app );
                file.write((char*)&obj, sizeof(obj));
                file.close();
            }
            else
                cout<<"/n/n Train Schedule Cancelled ";
        }
        void update_train()
        {
            long int train_no;
            cout<<"\n Enter Train Number of The Train to be updated : ";
            cin>>train_no;
            Train obj;
            ifstream f1("Train.dat", ios::binary );
            flag = 0;
            while( !f1.eof() )
            {
                f1.read( (char*)&obj, sizeof(obj) );
                if( train_no == obj.get_tno() )
                {
                    f1.seekg(-1*sizeof(obj), ios::cur );
                    long pos = f1.tellg();
                    f1.close();
                    flag = 1;
                    obj.get_details();
                    cout<<"\n\n Do You Want To Confirm This Train Schedule Change : ";
                    cin>>ch;
                    if(ch=='y'||ch=='Y')
                    {
                        ofstream f2("Train.dat", ios::ate | ios::binary);
                        f2.seekp( pos, ios::beg );
                        f2.write((char*)&obj, sizeof(obj));
                        f2.close();
                    }
                    break;
                }
            }
            if(flag == 0)
            {   cout<<"\n This Train Is Not Available ";    }
        }
        void delete_train()
        {
            long int train_no;
            cout<<"\n Enter Train Number of The Train To Be deleted : ";
            cin>>train_no;
            cout<<"Are You Sure You Want To Delete This Train Schedule : ";
            cin>>ch;
            if(ch=='y'||ch=='Y')
            {
                ifstream f1( "Train.dat", ios::binary );
                ofstream f2( "temp.dat", ios::binary | ios::out );
                Train obj;
                int flag = 0;
                while( !f1.eof() )
                {
                    f1.read((char*)&obj, sizeof(obj));
                    if(  obj.get_tno() != train_no )
                    {
                        f2.write((char*)&obj, sizeof(obj));
                    }
                    else
                        flag = 1;
                }
                if(flag == 0)
                    cout<<"\n No such train found ";
                f1.close();
                f2.close();
                remove("Train.dat");
                rename("temp.dat", "Train.dat");
            }
        }
        void update_ticket()
        {
            long int ticket_no;
            cout<<"\n Enter Ticket Number of The Booking to be updated : ";
            cin>>ticket_no;
            Passenger obj;
            ifstream f1("Pass.dat", ios::binary );
            flag = 0;
            while( !f1.eof() )
            {
                f1.read( (char*)&obj, sizeof(obj) );
                if( ticket_no == obj.tickno )
                {
                    f1.seekg(-1*sizeof(obj), ios::cur );
                    long pos = f1.tellg();
                    f1.close();
                    flag = 1;
                    obj.getdata();
                    cout<<"\n\n Do You Want To Confirm This Booking Change : ";
                    cin>>ch;
                    if(ch=='y'||ch=='Y')
                    {
                        ofstream f2("Pass.dat", ios::ate | ios::binary);
                        f2.seekp( pos, ios::beg );
                        f2.write((char*)&obj, sizeof(obj));
                        f2.close();
                    }
                    break;
                }
            }
            if(flag==0)
            {   cout<<"\n Booking Of This Ticket Number Is Not Available ";  }
        }
        void delete_ticket()
        {
            long int tick_no;
            cout<<"\n Enter Ticket Number of The Booking To Be Deleted : ";
            cin>>tick_no;
            ifstream f1( "Pass.dat", ios::binary );
            ofstream f2( "temp.dat", ios::binary | ios::app );
            Passenger obj;
            int flag = 0;
            while( !f1.eof() )
            {
                f1.read((char*)&obj, sizeof(obj));
                if(  obj.tickno != tick_no )
                {   f2.write((char*)&obj, sizeof(obj)); }
                else
                {   flag = 1;   }
            }
            if(flag == 0)
                cout<<"\n No such Booking found ";
            f1.close();
            f2.close();
            remove("Pass.dat");
            rename("temp.dat", "Pass.dat");
        }
        void display_bookings()
        {
            ifstream f1("Pass.dat", ios::binary);
            Passenger obj;
            flag = 0;
            long int check = 0;
            while( !f1.eof() )
            {
                f1.read((char*)&obj, sizeof(obj));
                if(strcmp(obj.mail, mail)==0)
                {
                    if(obj.tickno == check)
                    {   break;  }
                    check = obj.tickno;
                    obj.putdata();
                }
            }
            f1.close();
        }
        void pass_train()
        {
            Passenger obj;
            ifstream file("Pass.dat", ios::binary);
            long int train_no;
            cout<<"\n Enter Train Number : ";
            cin>>train_no;
            int flag = 0;
            while( !file.eof() )
            {
                file.read((char*)&obj, sizeof(obj));
                if(obj.get_tno() == train_no)
                {
                    obj.putdata();
                    flag++ ;
                }
            }
            if(flag == 0)
            {
                cout<<"\n This train has no bookings";
            }
            file.close();
        }
        ~Passenger()
        {

        }
};

void start()
{
    system("cls");                                               //####################################
    cout<<"------------------------------------------------------------------------------------"<<endl;
    cout<<"                                                   Railways                                                       "<<endl;
    cout<<"------------------------------------------------------------------------------------"<<endl<<endl;
}
int main()
{
    system("color 74");
    srand(time(0));
    Passenger p;
    Account a;
    int flag, choice, choice1;
    char email[40],password[20];
    Label :
    start();
    cout<<"\n Welcome to ..... Please enter any of the choices (1 or 2) given below -: ";
    cout<<"\n 1. Create An Account ";
    cout<<"\n 2. Login With Your Email & Password \n";
    cout<<"\n Enter Choice : ";
    flag = 0;
    while(flag ==0)
    {
        try
        {
            cin>>choice;
            if(choice==1 || choice==2 )
                {
                    flag = 1;
                }
            else
                {
                    cout<<"\n Enter choice between 1 - 2 ";
                    flag = 0;
                }
        }
        catch(...)
        {
            cout<<"\n Error : enter choice between 1 - 2 ";
            flag=0;
        }
    }
    start();
    if(choice == 1)
    {
        a.create_account();
    }
    cout<<"\n Enter Email Id : ";
    gets(email);
    p.set_mail(email);
    cout<<"\n Enter Password : ";
    gets(password);
    if(strcmp(email, "admin")==0)
        if(strcmp(password, "456")==0)
        {
            do
            {
                start();
                cout<<"\n Welcome to ..... Please enter any of the choices (1 or 2) given below -: ";
                cout<<"\n 1. Train Details ";
                cout<<"\n 2. Passenger Details \n";
                flag = 0;
                cout<<"\n Enter Choice : ";
                while(flag ==0)
                {
                    try
                    {
                        cin>>choice;
                        if(choice==1 || choice==2 )
                            flag = 1;
                        else
                            cout<<"\n Enter choice between 1 - 2 ";
                    }
                    catch(...)
                    {
                        cout<<"\n Error : enter choice between 1 - 2 ";
                        flag=0;
                    }
                }
                start();
                if(choice==1)
                {
                    cout<<"\n Welcome to ..... Please enter any of the choices ( 1-6 ) given below -: ";
                    cout<<"\n 1. Add Train Details ";
                    cout<<"\n 2. Update Train Details ";
                    cout<<"\n 3. Delete Train Details ";
                    cout<<"\n 4. Search For Train ";
                    cout<<"\n 5. Display Details Of All Trains ";
                    cout<<"\n 6. Display All Trains Between Cities \n";
                    cout<<"\n Enter Choice : ";
                    flag = 0;
                    while(flag ==0)
                    {
                        try
                        {
                            cin>>choice1;
                            if(choice1>=1 && choice1<=6 )
                                flag = 1;
                            else
                                cout<<"\n Enter choice between 1 - 2 ";
                        }
                        catch(...)
                        {
                            cout<<"\n Error : enter choice between 1 - 2 ";
                        }
                    }
                    switch (choice1)
                    {
                        case 1 :
                            p.add_train();
                            break;
                        case 2 :
                            p.update_train();
                            break;
                        case 3 :
                            p.delete_train();
                            break;
                        case 4 :
                            p.train_by_no();
                            break;
                        case 5 :
                            p.display_train();
                            break;
                        case 6 :
                            p.train_by_city();
                            break;
                    }
                }
                else if(choice==2)
                {
                    cout<<"\n Welcome to ..... Please enter any of the choices ( 1-6 ) given below -: ";
                    cout<<"\n 1. Book Ticket ";
                    cout<<"\n 2. Update Ticket Details ";
                    cout<<"\n 3. Delete Ticket Details ";
                    cout<<"\n 4. Search For Ticket ";
                    cout<<"\n 5. Display Info Of All Passengers Travelling In A Train ";
                    cout<<"\n 6. Display All Ticket Bookings \n";
                    flag = 0;
                    cout<<"\n Enter Choice : ";
                    while(flag == 0)
                    {
                        try
                        {
                            cin>>choice1;
                            if(choice1>=1 && choice1<=6 )
                                flag = 1;
                            else
                            {
                                cout<<"\n Enter choice between 1 - 2 ";
                            }
                        }
                        catch(...)
                        {
                            cout<<"\n Error : enter choice between 1 - 2 ";
                        }
                    }
                    switch (choice1)
                    {
                        case 1 :
                            p.book_ticket(email);
                            break;
                        case 2 :
                            p.update_ticket();
                            break;
                        case 3 :
                            p.delete_ticket();
                            break;
                        case 4 :
                            p.search_ticket();
                            break;
                        case 5 :
                            p.pass_train();
                            break;
                        case 6 :
                            p.display_tickets();
                            break;
                    }
                }
                cout<<"\n\n Do you want to Go To The Main Menu (Y/N) : ";
                cin>>ch;
            }while((ch=='Y')||(ch=='y'));
        }
        else
        {
            cout<<"\n Wrong Password !!! ";
            exit(0);
        }
    else
    {
        ifstream file("Acc.dat", ios::binary );
        Account obj;
        flag = 0;
        while(!file.eof())
        {
            file.read((char*)&obj, sizeof(obj));
            if(strcmp(obj.get_email(), email)==0)
            {
                flag = 1;
                break;
            }
        }
        if (flag == 0)
        {
            cout<<"\n Wrong Email ";
            goto Label;
        }
        if(strcmp(obj.get_pass(),password)==0)
        {
            cout<<"\n Welcome";
        }
        else
        {
            cout<<"\n Wrong Password !!!";
            Sleep(3000);
            exit(0) ;
        }
        file.close();
        do
        {
            start();
            cout<<"\n Welcome to ..... Please enter any of the choices ( 1-6 ) given below -: ";
            cout<<"\n 1. Book Tickets ";
            cout<<"\n 2. Update Ticket Details ";
            cout<<"\n 3. Delete Ticket Booking ";
            cout<<"\n 4. Search For Train ";
            cout<<"\n 5. View My Current Bookings ";
            cout<<"\n 6. Display All Trains Between Cities \n";
            flag = 0;
            cout<<"\n Enter Choice : ";
            while(flag ==0)
            {
                try
                {
                    cin>>choice1;
                    if(choice1>=1 && choice1<=6 )
                        flag = 1;
                    else
                        cout<<"\n Enter choice between 1 - 6 ";
                }
                catch(...)
                   {
                       cout<<"\n Error : enter choice between 1 - 6 ";
                   }
            }
            switch (choice1)
            {
                case 1 :
                    p.book_ticket(email);
                    break;
                case 2 :
                    p.update_ticket();
                    break;
                case 3 :
                    p.delete_ticket();
                    break;
                case 4 :
                    p.train_by_no();
                    break;
                case 5 :
                    p.display_bookings();
                    break;
                case 6 :
                    p.train_by_city();
                    break;
            }
            cout<<"\n\n Do you want to Go To The Main Menu (Y/N) : ";
            cin>>ch;
        }while((ch=='Y')||(ch=='y'));
    }
    getch();
    return 0;           
}
